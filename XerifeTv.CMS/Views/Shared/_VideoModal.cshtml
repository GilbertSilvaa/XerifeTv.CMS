
<div class="modal fade"
     id="videoModal"
     data-bs-backdrop="static"
     data-bs-keyboard="false"
     tabindex="-1"
     aria-labelledby="videoModalLabel"
     aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="videoModalLabel"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: 65vh;">
                <video id="player"
                       class="video-js vjs-default-skin w-100"
                       style="min-height: 100%; max-height: 100%;"
                       controls>
                </video>
            </div>
        </div>
    </div>
</div>

<script defer>
    const modal = document.getElementById('videoModal')
    let player = undefined

    if (modal) {
        modal.addEventListener('show.bs.modal', async event => {
            const button = event.relatedTarget

            const modalTitle = document.querySelector('.modal-title')
            modalTitle.textContent = button.getAttribute('data-bs-title')

            if (!player) {
                player = videojs('player', {
                    controls: true,
                    preload: 'auto',
                    playbackRates: [0.5, 1, 1.25, 1.5, 2],
                    controlBar: {
                        skipButtons: {
                            forward: 10,
                            backward: 10
                        }
                    }
                })

                player.hlsQualitySelector({
                    displayCurrentQuality: true
                })
            }

            const resolverUrl = button.getAttribute('data-bs-video-resolver')

            try {
                let finalUrl = null
                let streamFormat = null

                if (resolverUrl) {
                    const response = await fetch(resolverUrl)
                    if (!response.ok) throw new Error('Erro ao resolver URL')

                    const data = await response.json()
                    finalUrl = data.url || data.Url
                    streamFormat = data.streamFormat || data.StreamFormat || streamFormat             
                } 
                else {
                    finalUrl = button.getAttribute('data-bs-video-url')
                    streamFormat = button.getAttribute('data-bs-video-format')
                }

                streamFormat = streamFormat === 'mp4'
                        ? 'video/mp4'
                        : 'application/x-mpegURL'

                player.src({
                    src: finalUrl,
                    type: streamFormat
                })

                const subtitle = button.getAttribute('data-bs-video-subtitle')

                if (subtitle) {
                    player.addRemoteTextTrack({
                        kind: 'captions',
                        src: subtitle,
                        srclang: 'pt',
                        label: 'Português'
                    }, false)
                }

            } catch (err) {
                console.error('Erro ao carregar vídeo:', err)
            }
        })

        modal.addEventListener('hide.bs.modal', () => {
            if (player) {
                player.pause()
                player.reset()
            }
        })
    }
</script>
